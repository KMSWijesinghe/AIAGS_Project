<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Portfolio List</title>
    <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <div class="main-content">
            <h1 class="page-title" style="text-align: center;">View Portfolio</h1>

            <div class="content-card">
                <div class="filter-section">
                    <div class="filter-group">
                        <span class="filter-label">Select:</span>
                        <select class="filter-select" id="selectBatch">
                            <option value="">Select Batch</option>
                            <option value="2024">Batch 2024</option>
                            <option value="2023">Batch 2023</option>
                            <option value="2022">Batch 2022</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">Filter:</span>
                        <span class="filter-label">Status</span>
                        <select class="filter-select" id="filterStatus">
                            <option value="">Select Status</option>
                            <option value="PUBLISHED">Published</option>
                            <option value="DRAFT">Draft</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">Grade</span>
                        <select class="filter-select" id="filterGrade">
                            <option value="">Select Grade</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <span class="filter-label">Assignment</span>
                        <select class="filter-select" id="filterAssignment" disabled>
                            <option value="">Select Assignment</option>
                        </select>
                    </div>

                    <div class="search-group">
                        <span class="filter-label">Search Student:</span>
                        <input type="text" class="search-input" id="searchStudent" placeholder="" />
                    </div>

                    <button class="print-button" onclick="window.print()">ðŸ–¨</button>
                </div>

                <div class="table-container portfolio-table">
                    <div class="table-header">
                        <div class="table-header-cell">STUDENT NO</div>
                        <div class="table-header-cell">PORTFOLIO</div>
                        <div class="table-header-cell">STATUS</div>
                        <div class="table-header-cell">FINAL GRADE</div>
                        <div class="table-header-cell">VIEW REPORT</div>
                    </div>

                    <div class="table-body" id="tableBody">

                        <!-- Add batch + assignment info here -->
                        <div class="table-row" data-batch="2024" data-assignment="assignment1" data-portfolio-id="1">
                            <div class="table-cell">ME/2020/001</div>
                            <div class="table-cell">username_251120</div>
                            <div class="table-cell status-approved">Approved</div>
                            <div class="table-cell">B</div>
                            <div class="table-cell">
                                <span class="view-icon" role="button" tabindex="0" title="View Report">ðŸ“„</span>
                            </div>
                        </div>

                        <div class="table-row" data-batch="2023" data-assignment="assignment2" data-portfolio-id="2">
                            <div class="table-cell">ME/2020/002</div>
                            <div class="table-cell">username_251120</div>
                            <div class="table-cell status-pending">Pending</div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                        </div>

                        <div class="table-row empty-row">
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                        </div>

                        <div class="table-row empty-row">
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                        </div>

                        <div class="table-row empty-row">
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                            <div class="table-cell"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:4000";

        document.addEventListener("DOMContentLoaded", () => {
            const selectBatch = document.getElementById("selectBatch");
            const filterStatus = document.getElementById("filterStatus");
            const filterGrade = document.getElementById("filterGrade");
            const filterAssignment = document.getElementById("filterAssignment");
            const searchStudent = document.getElementById("searchStudent");
            const tableBody = document.getElementById("tableBody");

            // init assignment dropdown
            filterAssignment.innerHTML = "<option value=''>Select Batch First</option>";
            filterAssignment.disabled = true;

            // Batch -> load assignments
            selectBatch.addEventListener("change", async () => {
                await loadAssignmentsForBatch(selectBatch.value);

                // clear table until assignment chosen
                tableBody.innerHTML = "";
            });

            // Assignment -> load results
            filterAssignment.addEventListener("change", async () => {
                await loadResults();
                filterTable();
            });

            // client-side filters
            filterStatus.addEventListener("change", filterTable);
            filterGrade.addEventListener("change", filterTable);
            searchStudent.addEventListener("input", filterTable);

            async function authFetch(url) {
                const token = localStorage.getItem("aigs_token");
                return fetch(url, {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });
            }

            // âœ… load assignments only for selected batch
            async function loadAssignmentsForBatch(batch) {
                filterAssignment.innerHTML = "<option value=''>Loading...</option>";
                filterAssignment.disabled = true;

                if (!batch) {
                    filterAssignment.innerHTML = "<option value=''>Select Batch First</option>";
                    return;
                }

                try {
                    const url = `${API_BASE}/api/assignments?batch=${encodeURIComponent(batch)}`;
                    const resp = await authFetch(url);

                    if (!resp.ok) {
                        const t = await resp.text();
                        console.error("Assignments error:", resp.status, t);
                        filterAssignment.innerHTML = "<option value=''>Failed to load assignments</option>";
                        return;
                    }

                    const data = await resp.json();
                    const assignments = data.assignments || [];

                    filterAssignment.innerHTML = "<option value=''>Select Assignment</option>";

                    if (assignments.length === 0) {
                        filterAssignment.innerHTML = `<option value=''>No assignments for batch ${batch}</option>`;
                        filterAssignment.disabled = true;
                        return;
                    }

                    for (const a of assignments) {
                        const opt = document.createElement("option");
                        opt.value = String(a.assignment_id);
                        opt.textContent = a.assignment_name; // e.g. CA1
                        filterAssignment.appendChild(opt);
                    }

                    filterAssignment.disabled = false;
                } catch (e) {
                    console.error("loadAssignmentsForBatch failed:", e);
                    filterAssignment.innerHTML = "<option value=''>Failed to load assignments</option>";
                }
            }

            // âœ… load results for selected assignment (includes final_grade + status)
            async function loadResults() {
                const assignmentId = filterAssignment.value;

                if (!assignmentId) {
                    tableBody.innerHTML = "";
                    return;
                }

                try {
                    const url = `${API_BASE}/api/grading/assignment/${encodeURIComponent(assignmentId)}/results`;
                    const resp = await authFetch(url);

                    if (!resp.ok) {
                        const t = await resp.text();
                        console.error("Results error:", resp.status, t);
                        tableBody.innerHTML = `<div style="padding:12px;">Failed to load results</div>`;
                        return;
                    }

                    const data = await resp.json();
                    const results = data.results || [];

                    tableBody.innerHTML = results.map(r => rowHtml(r)).join("");
                } catch (e) {
                    console.error("Failed to load results:", e);
                    tableBody.innerHTML = `<div style="padding:12px;">Failed to load results</div>`;
                }
            }

            function gradeToLetter(n) {
                if (n === null || n === undefined || n === "") return "";
                const x = Number(n);
                if (Number.isNaN(x)) return "";
                if (x >= 75) return "A";
                if (x >= 65) return "B";
                if (x >= 55) return "C";
                return "D";
            }

            function rowHtml(r) {
                const letter = gradeToLetter(r.final_grade);
                const status = r.status || "DRAFT";
                const statusClass = status === "PUBLISHED" ? "status-approved" : "status-pending";

                return `
        <div class="table-row"
             data-portfolio-id="${escapeHtml(r.portfolio_id)}"
             data-status="${escapeHtml(status)}"
             data-grade="${escapeHtml(letter)}">
          <div class="table-cell">${escapeHtml(r.student_no || "")}</div>
          <div class="table-cell">${escapeHtml((r.portfolio_link || "").split("/").pop() || "")}</div>
          <div class="table-cell ${statusClass}">${escapeHtml(status)}</div>
          <div class="table-cell">${escapeHtml(letter)}</div>
          <div class="table-cell">
            <span class="view-icon" role="button" tabindex="0" title="View Report">ðŸ“„</span>
          </div>
        </div>
      `;
            }

            function filterTable() {
                const statusFilter = (filterStatus.value || "").trim();
                const gradeFilter = (filterGrade.value || "").trim();
                const searchText = (searchStudent.value || "").toLowerCase();

                const rows = document.querySelectorAll(".table-row");
                rows.forEach(row => {
                    // Skip any empty filler rows
                    if (row.classList.contains("empty-row")) return;

                    const studentNo = (row.children[0]?.textContent || "").toLowerCase();
                    const rowStatus = row.dataset.status || "";
                    const rowGrade = row.dataset.grade || "";

                    let show = true;
                    if (statusFilter && rowStatus !== statusFilter) show = false;
                    if (gradeFilter && rowGrade !== gradeFilter) show = false;
                    if (searchText && !studentNo.includes(searchText)) show = false;

                    row.style.display = show ? "grid" : "none";
                });
            }

            function escapeHtml(s) {
                return String(s ?? "")
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("'", "&#039;");
            }
        });

        // View report click (works for dynamically created rows too)
        document.addEventListener("click", (e) => {
            const icon = e.target.closest(".view-icon");
            if (!icon) return;

            const row = icon.closest(".table-row");
            const portfolioId = row?.dataset?.portfolioId;

            if (portfolioId) {
                window.location.href = `view_report.html?portfolio_id=${encodeURIComponent(portfolioId)}`;
            }
        });
    </script>


</body>

</html>